C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\I2C.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\libfnd\I2C.c BROWSE DEBUG OBJECTEXTEND PRINT(.\I2C.lst) OBJECT(.\I2C.obj
                    -)

line level    source

   1          #include <INTRINS.h>
   2          #include "I2C.h"
   3          #include "Uart.h"
   4          
   5          
   6          /*
   7                  I2C.c
   8                  ׼80C51ƬģI2Cߵ
   9                  ѧϰοṩκοɿԷĵҵĿ
  10          ˵
  11                  һC51ģI2CЭľ汾
  12                  ֻһģʽǶģʽ
  13                  I2CЭеʱͬ
  14                  Ҫ˽ⱾϸڣοPhilips˾Э׼
  15          ÷
  16                  1. ļI2C.hI2C.cһƵĹļ
  17                  2. ʵʵƬͺţSFRͷļ<reg52.h>
  18                  3. ʵʵ·޸I2CźSCLSDAĶ
  19                  4. ͨ궨I2C_DELAY_VALUEI2CߵٶʹʵҪ
  20                  5. ļI2C.cӽУҪĵطͷļI2C.h
  21                  6. main()ĿʼҪһγʼI2C_Init()
  22                  7. I2C_Puts()I2C_Gets()I2Cۺ϶д뿴עͺʹ
  23                  8. ȫʵıʶI2C_ͷЧͻ
  24                  9. ע⣺ӻַ7λַʾдλλЧ
  25          */
  26          
  27          // I2CʱӵʱֵҪʵ޸ģȡֵ1255
  28          // 1TƬ@11.0592MHzƵ£ֻҪֵ10ôʱʱͳ4.7uS
  29          // ǵ1TƬIOڿӦĸı䣬ԼݺͷֲɵĲαԵֵͣӦԴ
             -ڼֵ
  30          #define I2C_DELAY_VALUE         20
  31          
  32          // I2Cֹͣһοʼ֮ǰĵȴʱ䣬ȡֵ165535
  33          // ȴʱΪ(I2C_STOP_WAIT_VALUE*5)/ƵuS
  34          // ڶȡֵΪ1ɣĳЩ˵ϳʱǱ
  35          #define I2C_STOP_WAIT_VALUE             1
  36          
  37          // I2CȴӻӦĳʱʱ䣬ȡֵ1~65535
  38          #define I2C_WAIT_ACK_TIMEOUT    255
  39          
  40          
  41          // ģI2CߵŶ
  42          sbit I2C_SCL = P0^1;
  43          sbit I2C_SDA = P0^0;
  44          
  45          
  46          /*
  47          I2C_Delay()
  48          ܣʱģI2Cר
  49          ˵ʱʱΪ((6+2+I2C_DELAY_VALUE*4+4)/Ƶ)uS
  50          */
  51          static void I2C_Delay(){
  52   1              u8 I2C_Delay_t = (I2C_DELAY_VALUE);
  53   1              while(--I2C_Delay_t != 0);
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 2   

  54   1      }
  55          
  56          /*
  57          I2C_Init()
  58          ܣI2C߳ʼʹߴڿ״̬
  59          ˵main()ĿʼͨӦҪִһα
  60          */
  61          void I2C_Init(){
  62   1              P0M0 |= 0x03;
  63   1              P0M1 |= 0x03;   // I2C_SCLI2C_SDAóɿ©
  64   1              
  65   1              I2C_SCL = 1;
  66   1              I2C_Delay();
  67   1              I2C_SDA = 1;
  68   1              I2C_Delay();
  69   1      }
  70          
  71          /*
  72          I2C_Start()
  73          ܣI2Cߵʼ״̬
  74          ˵
  75                  SCLڸߵƽڼ䣬SDA½ʱI2C
  76                  SDASCLʲôƽ״̬ȷʼ״̬
  77                  Ҳظʼ״̬
  78                  ִкI2Cߴæ״̬
  79          */
  80          void I2C_Start(){
  81   1              I2C_SDA = 1;
  82   1              I2C_Delay();
  83   1              I2C_SCL = 1;
  84   1              I2C_Delay();
  85   1              I2C_SDA = 0;
  86   1              I2C_Delay();
  87   1              I2C_SCL = 0;
  88   1              I2C_Delay();
  89   1      }
  90          
  91          /*
  92          I2C_Write()
  93          ܣI2Cд1ֽڵ
  94          
  95                  datҪдϵ
  96          */ 
  97          void I2C_Write(u8 dat){
  98   1              u8 t = 8;
  99   1              do{
 100   2                      I2C_SDA = (bit)(dat & 0x80);
 101   2                      I2C_Delay();
 102   2                      I2C_SCL = 1;
 103   2                      I2C_Delay();
 104   2                      I2C_SCL = 0;
 105   2                      I2C_Delay();
 106   2                      dat <<= 1;
 107   2              }while(--t != 0);
 108   1      }
 109          
 110          /*
 111          I2C_Read()
 112          ܣӴӻȡ1ֽڵ
 113          أȡһֽ
 114          */
 115          u8 I2C_Read(){
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 3   

 116   1              u8 dat;
 117   1              u8 t = 8;
 118   1              I2C_SDA = 1;    // ڶȡ֮ǰҪSDA
 119   1              I2C_Delay();
 120   1              do{
 121   2                      I2C_SCL = 1;            // ͷSCLߣȴӻ
 122   2                      I2C_Delay();
 123   2                      while(!I2C_SCL);        // ȴӻͷSCLӻͷSCLӻѾSDA׼ã̶ȡ
 124   2                      dat <<= 1;
 125   2                      dat |= I2C_SDA;
 126   2                      I2C_SCL = 0;
 127   2                      I2C_Delay();
 128   2              }while(--t != 0);
 129   1              return dat;
 130   1      }
 131          
 132          /*
 133          I2C_GetAck()
 134          ܣȡӻӦλ
 135          أ
 136                  0ӻӦ
 137                  1ӻӦ
 138          ˵
 139                  ӻյϵĵַԼĵַͬӦλ
 140                  ӻյÿֽڵݺҪӦλ
 141                  ӻյ1ֽڵݺһҪӦλ
 142          */
 143          bit I2C_GetAck(){
 144   1              u16 timeout = I2C_WAIT_ACK_TIMEOUT;
 145   1              I2C_SDA = 1;
 146   1              I2C_Delay();
 147   1              I2C_SCL = 1;
 148   1              I2C_Delay();
 149   1              while(I2C_SDA){
 150   2                      timeout--;
 151   2                      if(timeout==0){
 152   3                              //Uart_String("Not Acknowledged.\r\n");
 153   3                              return 1;
 154   3                      }
 155   2              }
 156   1              I2C_SCL = 0;
 157   1              I2C_Delay();
 158   1              return 0;
 159   1      }
 160          
 161          /*
 162          I2C_PutAck()
 163          ܣӦλӦλ
 164          
 165                  ack=0Ӧλ
 166                  ack=1Ӧλ
 167          ˵
 168                  ڽÿһֽڵݺ󣬶ӦӦλ
 169                  ڽһֽڵݺӦӦλ
 170          */
 171          void I2C_PutAck(bit ack){
 172   1              I2C_SDA = ack;
 173   1              I2C_Delay();
 174   1              I2C_SCL = 1;
 175   1              I2C_Delay();
 176   1              I2C_SCL = 0;
 177   1              I2C_Delay();
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 4   

 178   1      }
 179          
 180          /*
 181          I2C_Stop()
 182          ܣI2Cߵֹͣ״̬
 183          ˵
 184                  SCLڸߵƽڼ䣬SDAʱֹͣI2C
 185                  SDASCLʲôƽ״̬ȷֹͣ״̬
 186                  ִкI2Cߴڿ״̬
 187          */
 188          void I2C_Stop(){
 189   1              u16 t = I2C_STOP_WAIT_VALUE;
 190   1              I2C_SDA = 0;
 191   1              I2C_Delay();
 192   1              I2C_SCL = 1;
 193   1              I2C_Delay();
 194   1              I2C_SDA = 1;
 195   1              I2C_Delay();
 196   1              while(--t != 0);        // һβStart֮ǰҪһʱ
 197   1      }
 198          
 199          /*
 200          CheckI2CSlaveValidity()
 201          ܣеI2CϷַ
 202          ˵
 203                  ͼдַӦ˵Ϸ
 204          */
 205          void CheckI2CSlaveValidity(){
 206   1              u8 i = 0;
 207   1              Uart_String("Start checking slaves!\r\n");
 208   1              I2C_Init();
 209   1              while(1){
 210   2                      bit result;
 211   2                      I2C_Start();
 212   2                      I2C_Write(i);
 213   2                      result = I2C_GetAck();
 214   2                      if(result == 0){
 215   3                              Uart_String("Slave ");
 216   3                              Uart_Hex(i);
 217   3                              Uart_String(" is valid.\r\n");
 218   3                      }
 219   2                      I2C_Stop();
 220   2                      i++;
 221   2                      if(i == 0)break;
 222   2              }
 223   1              Uart_String("Finished checking slaves!\r\n");
 224   1      }
 225          
 226          /*
 227          I2C_Puts()
 228          ܣI2CۺϷͺӻͶֽڵ
 229          
 230                  SlaveAddrӻַ7λַдλ
 231                  SubAddrӻӵַ
 232                  SubModӵַģʽ0ӵַ1ֽӵַ2˫ֽӵַ
 233                  *datҪ͵
 234                  Sizeݵֽ
 235          أ
 236                  0ͳɹ
 237                  1ڷ͵ַг쳣
 238                  -1ڷݹг쳣
 239          ˵
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 5   

 240                  ܹܺõӦгI2CǷӵַ
 241                  ӻûӵַʱSubAddr⣬SubModӦΪ0
 242          */
 243          s8 I2C_Puts(u8 SlaveAddr, u16 SubAddr, u8 SubMod, u8* dat, u16 Size){
 244   1              // ʱ
 245   1              u8 i;
 246   1              u8 a[3];
 247   1              // 鳤
 248   1              if(Size == 0)return 0;
 249   1              // ׼ӻַ
 250   1              a[0] = (SlaveAddr << 1);
 251   1              // ӵַģʽ
 252   1              if(SubMod > 2)SubMod = 2;
 253   1              // ȷӵַ
 254   1              switch(SubMod){
 255   2              case 0:
 256   2                      break;
 257   2              case 1:
 258   2                      a[1] = (u8)(SubAddr & 0xFF);
 259   2                      break;
 260   2              case 2:
 261   2                      a[1] = (u8)((SubAddr >> 8) & 0xFF);
 262   2                      a[2] = (u8)(SubAddr & 0xFF);
 263   2                      break;
 264   2              default:
 265   2                      break;
 266   2              }
 267   1              // ʹӻַŷӵַӵַĻ
 268   1              SubMod++;
 269   1              I2C_Start();
 270   1              for(i=0;i<SubMod;++i){
 271   2                      I2C_Write(a[i]);
 272   2                      if(I2C_GetAck()){
 273   3                              I2C_Stop();
 274   3                              return 1;
 275   3                      }
 276   2              }
 277   1              // 
 278   1              do{
 279   2                      I2C_Write(*dat++);
 280   2                      if(I2C_GetAck())break;
 281   2              }while(--Size != 0);
 282   1              // ϣֹͣI2Cߣؽ
 283   1              I2C_Stop();
 284   1              if(Size == 0){ 
 285   2                      return 0;
 286   2              }else{
 287   2                      return -1;
 288   2              }
 289   1      }
 290          
 291          /*
 292          I2C_Gets()
 293          ܣI2CۺϽպӴӻնֽڵ
 294          
 295                  SlaveAddrӻַ7λַдλ
 296                  SubAddrӻӵַ
 297                  SubModӵַģʽ0ӵַ1ֽӵַ2˫ֽӵַ
 298                  *datյ
 299                  Sizeݵֽ
 300          أ
 301                  0ճɹ
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 6   

 302                  1ڽչ̵ķ͵ַʱ쳣
 303          ˵
 304                  ܹܺõӦгI2CǷӵַ
 305                  ӻûӵַʱSubAddr⣬SubModӦΪ0
 306          */
 307          s8 I2C_Gets(u8 SlaveAddr, u16 SubAddr, u8 SubMod, u8* dat, u16 Size){
 308   1              // ʱ
 309   1              u8 i;
 310   1              u8 a[3];
 311   1              // 鳤
 312   1              if(Size == 0)return 0;
 313   1              // ׼ӻַ
 314   1              a[0] = (SlaveAddr << 1);
 315   1              // ӵַģʽ
 316   1              if(SubMod > 2)SubMod = 2;
 317   1              // ӵַĴӻҪȷʹӻַӵַ
 318   1              if(SubMod != 0){
 319   2                      //ȷӵַ
 320   2                      if(SubMod == 1){
 321   3                              a[1] = (u8)(SubAddr & 0xFF);
 322   3                      }else{
 323   3                              a[1] = (u8)((SubAddr >> 8) & 0xFF);
 324   3                              a[2] = (u8)(SubAddr & 0xFF);
 325   3                      }
 326   2                      // ʹӻַŷӵַ
 327   2                      SubMod++;
 328   2                      I2C_Start();
 329   2                      for(i=0;i<SubMod;++i){
 330   3                              I2C_Write(a[i]);
 331   3                              if(I2C_GetAck()){
 332   4                                      I2C_Stop();
 333   4                                      return 1;
 334   4                              }
 335   3                      }
 336   2              }
 337   1              // I2C_Start()ӵַĴӻظʼ״̬
 338   1              // ӵַĴӻʼ״̬
 339   1              I2C_Start();
 340   1              // ʹӻַ
 341   1              I2C_Write(a[0] + 1);
 342   1              if(I2C_GetAck()){
 343   2                      I2C_Stop();
 344   2                      return 1;
 345   2              }
 346   1              // 
 347   1              for(;;){
 348   2                      *dat++ = I2C_Read();
 349   2                      if(--Size == 0){
 350   3                              I2C_PutAck(1);
 351   3                              break;
 352   3                      }
 353   2                      I2C_PutAck(0);
 354   2              }
 355   1              // ϣֹͣI2Cߣؽ
 356   1              I2C_Stop();
 357   1              return 0;
 358   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    490    ----
   CONSTANT SIZE    =     73    ----
C51 COMPILER V9.52.0.0   I2C                                                               12/12/2017 17:09:05 PAGE 7   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
